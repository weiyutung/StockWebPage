<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>股票資料展示</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
      body {
        display: flex;
        flex-direction: row;
        margin: 0;
        font-family: Arial, sans-serif;
      }
      #main-content {
        width: 75%;
        padding: 20px;
        box-sizing: border-box;
      }
      #right-panel {
        width: 25%;
        padding: 20px;
        background: #f9f9f9;
        border-left: 1px solid #ccc;
        box-sizing: border-box;
        overflow-y: auto;
      }
      .checkbox-group label {
        display: block;
        margin: 10px 0;
        font-size: 16px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }
      th {
        background-color: #f2f2f2;
      }
      select,
      input[type="date"],
      input[type="text"],
      button {
        font-size: 16px;
        margin: 5px;
        padding: 5px;
      }
      #chart {
        max-width: 100%;
        margin-top: 50px;
      }
      #suggestions {
        border: 1px solid #ccc;
        position: absolute;
        background: white;
        width: 300px;
        display: none;
        z-index: 10;
      }

      /* 時間列容器 */
      .time-range-bar {
        display: flex;
        gap: 12px;
        align-items: center;
        font-size: 15px;
        font-family: Arial, sans-serif;
      }

      /* 單個選項 */
      .time-range-item {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background 0.2s, color 0.2s;
      }

      /* 預設樣式 */
      .time-range-item:hover {
        background-color: #f2f2f2;
      }

      /* 選中狀態 */
      .time-range-item.active {
        background-color: #f0f0f0;
        font-weight: bold;
      }

      /* 日曆圖案按鈕 */
      .calendar-btn {
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background 0.2s;
      }

      .calendar-btn:hover {
        background-color: #f2f2f2;
      }

      .calendar-btn svg {
        width: 18px;
        height: 18px;
        fill: #333;
      }

      /* 自訂時間容器（初始隱藏） */
      #customDateRange {
        display: none;
        align-items: center;
        gap: 6px;
        margin-left: 8px;
      }

      #customDateRange input[type="date"] {
        padding: 4px 6px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 14px;
      }

      #customDateRange button {
        padding: 4px 8px;
        font-size: 14px;
        background-color: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      #customDateRange button:hover {
        background-color: #1976d2;
      }
      h1,
      h2,
      h3 {
        color: #333;
      }
    </style>
  </head>
  <body>
    <div id="main-content">
      <h1>股票資料</h1>

      <label for="symbolInput">搜尋股票：</label>
      <input
        type="text"
        id="symbolInput"
        placeholder="輸入股票代號或名稱"
        autocomplete="off"
      />
      <div id="suggestions"></div>

      <div>
        <h2
          id="chartTitle"
          style="text-align: left; font-weight: bold; margin: 0; padding: 0"
        ></h2>
        <div
          id="ohlcInfo"
          style="text-align: left; font-size: 16px; padding: 5px 0"
        ></div>
        <div class="time-range-bar">
          <div class="time-range-item" onclick="setActive(this, '5d')">5天</div>
          <div class="time-range-item" onclick="setActive(this, '1m')">1月</div>
          <div class="time-range-item" onclick="setActive(this, '3m')">3月</div>
          <div class="time-range-item" onclick="setActive(this, '6m')">6月</div>
          <div class="time-range-item" onclick="setActive(this, 'ytd')">
            YTD
          </div>
          <div class="time-range-item" onclick="setActive(this, '1y')">1年</div>
          <div class="time-range-item" onclick="setActive(this, '5y')">5年</div>

          <!-- 日曆按鈕與自訂時間容器 -->
          <div class="calendar-btn" onclick="toggleCustomDate()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M19 4h-1V2h-2v2H8V2H6v2H5C3.9 4 3 4.9 3 6v14c0 
      1.1.9 2 2 2h14c1.1 0 2-.9 
      2-2V6c0-1.1-.9-2-2-2zm0 
      16H5V9h14v11z"
              />
            </svg>
          </div>
          <div id="customDateRange">
            起：<input type="date" id="customStart" /> 迄：<input
              type="date"
              id="customEnd"
            />
            <button onclick="loadStockWithRange(getSymbol(), 'custom')">
              查詢
            </button>
          </div>
        </div>
        <div id="chart"></div>
      </div>
    </div>

    <div
      id="main-chart-row"
      style="display: flex; align-items: stretch; min-height: 500px"
    >
      <!-- 圖表 -->
      <div style="flex: 1">
        <div id="chart" style="min-height: 500px"></div>
      </div>

      <!-- 右側功能（與圖表等高） -->
      <div
        style="
          margin-left: 10px;
          display: flex;
          flex-direction: column;
          margin-top: 250px;
        "
      >
        <div style="flex: 1; display: flex">
          <!-- 技術指標控制 -->
          <div style="width: 140px; flex: 1; padding: 5px">
            <h3 style="margin-top: 0">顯示技術線</h3>
            <div class="checkbox-group">
              <label
                ><input type="checkbox" class="indicator-check" value="Sma 5" />
                SMA 5</label
              >
              <label
                ><input
                  type="checkbox"
                  class="indicator-check"
                  value="Sma 10"
                />
                SMA 10</label
              >
              <label
                ><input
                  type="checkbox"
                  class="indicator-check"
                  value="Sma 20"
                />
                SMA 20</label
              >
              <label
                ><input
                  type="checkbox"
                  class="indicator-check"
                  value="Sma 60"
                />
                SMA 60</label
              >
              <label
                ><input
                  type="checkbox"
                  class="indicator-check"
                  value="Sma 120"
                />
                SMA 120</label
              >
              <label
                ><input
                  type="checkbox"
                  class="indicator-check"
                  value="Sma 240"
                />
                SMA 240</label
              >
              <label
                ><input type="checkbox" class="indicator-check" value="MACD" />
                DIF (快線)
              </label>
              <label
                ><input
                  type="checkbox"
                  class="indicator-check"
                  value="Macd Dea"
                />
                DEA (慢線)
              </label>
              <label
                ><input type="checkbox" class="indicator-check" value="K" />
                K</label
              >
              <label
                ><input type="checkbox" class="indicator-check" value="D" />
                D</label
              >
              <label
                ><input type="checkbox" class="indicator-check" value="J" />
                J</label
              >
              <label
                ><input type="checkbox" class="indicator-check" value="Bias" />
                Bias</label
              >
            </div>
          </div>

          <!-- 條件判斷區 -->
          <div style="width: 180px; flex: 1; padding: 5px">
            <h3 style="margin-top: 0">條件判斷選擇</h3>
            <div class="checkbox-group">
              <label
                ><input type="checkbox" class="rule-check" value="sma-cross" />
                SMA 短期 > 長期</label
              >
              <label
                ><input type="checkbox" class="rule-check" value="macd-cross" />
                MACD 上穿 Signal</label
              >
              <label
                ><input type="checkbox" class="rule-check" value="kd-cross" /> K
                上穿 D 且 K < 20</label
              >
              <label
                ><input type="checkbox" class="rule-check" value="bias-high" />
                Bias > 5</label
              >
              <label
                ><input type="checkbox" class="rule-check" value="bias-low" />
                Bias < -5</label
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = "https://sbzzfjlmhvuchzwqllgf.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNienpmamxtaHZ1Y2h6d3FsbGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3NDE2OTQsImV4cCI6MjA2ODMxNzY5NH0.fvDVLvGLQdMRuCMXmja8ltpXC3TcjZxq78xbnt9Bh-U";

      const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      let chart;
      let originalMinX = null;
      let originalMaxX = null;

      const allIndicators = [
        "Sma 5",
        "Sma 10",
        "Sma 20",
        "Sma 60",
        "Sma 120",
        "Sma 240",
        "MACD",
        "MACD Dea",
        "K",
        "D",
        "J",
        "Bias",
      ];

      function getSymbol() {
        return document.getElementById("symbolInput").value || "AAPL";
      }

      function selectSymbol(symbol) {
        document.getElementById("symbolInput").value = symbol;
        document.getElementById("suggestions").style.display = "none";
        loadStockWithRange(symbol, "1y"); // Default to 1 year on new selection
      }

      async function loadStockWithRange(symbol, range) {
        const rangeToCount = {
          "5d": 5,
          "1m": 22,
          "3m": 66,
          "6m": 132,
          "1y": 264,
          "5y": 1320,
        };
        let count = rangeToCount[range] || 264;

        // YTD calculation
        if (range === "ytd") {
          const today = new Date();
          const startOfYear = new Date(today.getFullYear(), 0, 1);
          const diffTime = Math.abs(today - startOfYear);
          count = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        const { data, error } = await client
          .from("stocks")
          .select(
            'date, symbol, open, high, low, close, volume, "Sma 5", "Sma 10", "Sma 20", "Sma 60", "Sma 120", "Sma 240", DIF, "DEA", K, D, J, Bias'
          )
          .eq("symbol", symbol)
          .order("date", { ascending: false })
          .limit(count);

        if (error || !data || data.length === 0) return alert("查無資料");
        const sortedData = data.sort(
          (a, b) => new Date(a.date) - new Date(b.date)
        );
        displayStockData(sortedData, symbol);

        console.log("symbol:", symbol, "count:", count);
        console.log("error:", error);
        console.log("data:", data);
      }

      function displayStockData(data, symbol) {
        window.stockData = data;

        const tradingDates = data.map((row) => {
          const date = new Date(row.date);
          return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(
            2,
            "0"
          )}-${String(date.getDate()).padStart(2, "0")}`;
        });

        const chartData = data.map((row, idx) => ({
          x: idx,
          y: [
            parseFloat(row.open),
            parseFloat(row.high),
            parseFloat(row.low),
            parseFloat(row.close),
          ],
        }));

        const volumeData = data.map((row, idx) => ({
          x: idx,
          y: parseFloat(row.volume),
        }));

        const prices = data.flatMap((r) => [
          parseFloat(r.high),
          parseFloat(r.low),
        ]);

        // 標題
        document.getElementById("chartTitle").innerText = `${symbol}`;
        document.getElementById("ohlcInfo").innerHTML =
          "將滑鼠懸停在圖表上以查看詳細資訊";

        const minY = Math.min(...prices) * 0.3;
        const maxY = Math.max(...prices) * 1.05;

        if (chart) chart.destroy();

        const options = {
          chart: { type: "candlestick", height: 500, zoom: { enabled: true } },
          legend: {
            show: false,
          },

          xaxis: {
            type: "category",
            categories: tradingDates,
            tickAmount: 20,
            labels: {
              rotate: -45,
              formatter: (v) => (v ? v.split("-").slice(1).join("/") : ""),
            },
          },
          yaxis: [
            {
              title: { text: "價格 / SMA / Bias" },
              min: minY,
              max: maxY,
              labels: { formatter: (val) => Number(val.toFixed(2)) },
              opposite: false, // 🔑 主價格軸在左
            },
            {
              title: { text: "Volume" },
              labels: { formatter: (val) => Number(val.toFixed(0)) },
              opposite: true, // 🔑 成交量永遠在右
              show: true,
            },
            {
              title: { text: "MACD / KDJ " },
              show: false,
              tickAmount: 5,
              labels: { formatter: (val) => Number(val.toFixed(2)) },
              opposite: false, // 🔑 動量軸也在左
            },
          ],

          series: [
            { name: "K線圖", type: "candlestick", data: chartData },
            {
              name: "成交量",
              type: "bar",
              data: volumeData,
              yAxisIndex: 1,
              color: "rgba(100,149,237,0.4)",
            },
          ],
          tooltip: {
            shared: true,
            custom: function ({ series, seriesIndex, dataPointIndex, w }) {
              const ohlc = w.globals.initialSeries[0].data[dataPointIndex].y;
              const date = tradingDates[dataPointIndex];
              const color = ohlc[3] > ohlc[0] ? "#2ecc71" : "#e74c3c";
              document.getElementById("ohlcInfo").innerHTML =
                `日期: ${date}　` +
                `<span style='color:${color}'>開: ${ohlc[0].toFixed(
                  2
                )} 高: ${ohlc[1].toFixed(2)} 低: ${ohlc[2].toFixed(
                  2
                )} 收: ${ohlc[3].toFixed(2)}</span>`;

              let tooltipText = "";
              series.forEach((s, i) => {
                if (i > 1) {
                  // Skip candlestick and volume
                  const val = s[dataPointIndex];
                  if (val) {
                    tooltipText += `<div><span>${
                      w.globals.seriesNames[i]
                    }:</span> <span style="font-weight: bold">${val.toFixed(
                      2
                    )}</span></div>`;
                  }
                }
              });
              return `<div class="apexcharts-tooltip-title" style="background: #ECEFF1; color: #333">${date}</div><div class="apexcharts-tooltip-series-group" style="padding:5px">${tooltipText}</div>`;
            },
          },
        };

        chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

        const indicatorFieldMap = {
          "Sma 5": "Sma 5",
          "Sma 10": "Sma 10",
          "Sma 20": "Sma 20",
          "Sma 60": "Sma 60",
          "Sma 120": "Sma 120",
          "Sma 240": "Sma 240",
          MACD: "Macd",
          "Macd Dea": "Macd Dea",
          K: "K",
          D: "D",
          J: "J",
          Bias: "Bias",
        };

        const indicatorGroups = {
          price: ["Sma 5", "Sma 10", "Sma 20", "Sma 60", "Sma 120", "Sma 240"],
          momentum: ["Bias", "Macd", "Macd Dea", "K", "D", "J"],
        };

        document.querySelectorAll(".indicator-check").forEach((checkbox) => {
          checkbox.onchange = () => {
            const checked = Array.from(
              document.querySelectorAll(".indicator-check:checked")
            ).map((cb) => cb.value);

            // 🔑 永遠保留 K線 + 成交量
            let newSeries = [
              { name: "K線圖", type: "candlestick", data: chartData },
              {
                name: "成交量",
                type: "bar",
                data: volumeData,
                yAxisIndex: 1,
                color: "rgba(100,149,237,0.4)",
              },
            ];

            // 如果沒勾 → 只顯示 K線+成交量
            if (checked.length === 0) {
              chart.updateOptions({
                series: newSeries,
                yaxis: [
                  { ...chart.w.config.yaxis[0], show: true },
                  { ...chart.w.config.yaxis[1], show: true },
                  { ...chart.w.config.yaxis[2], show: false },
                ],
              });
              return;
            }

            let momentumSelected = false;

            checked.forEach((name) => {
              const field = indicatorFieldMap[name];
              if (!field) return;
              const dataSeries = data.map((row, idx) => ({
                x: idx,
                y: row[field] != null ? parseFloat(row[field]) : null,
              }));

              let yAxisIndex = 0;
              if (indicatorGroups.momentum.includes(name)) {
                yAxisIndex = 2;
                momentumSelected = true;
              }

              newSeries.push({
                name,
                type: "line",
                data: dataSeries,
                yAxisIndex,
              });
            });

            chart.updateOptions({
              series: newSeries,
              yaxis: [
                { ...chart.w.config.yaxis[0], show: true },
                { ...chart.w.config.yaxis[1], show: true }, // 🔑 成交量永遠顯示
                { ...chart.w.config.yaxis[2], show: momentumSelected },
              ],
            });
          };
          checkbox.onmouseenter = () => {
            const name = checkbox.value;
            // 找對應 series index
            const idx = chart.w.globals.seriesNames.indexOf(name);
            if (idx >= 0) {
              chart.updateOptions({
                stroke: {
                  width: chart.w.config.series.map(
                    (s, i) => (i === idx ? 4 : 1) // hover 的那條加粗
                  ),
                },
              });
            }
          };

          checkbox.onmouseleave = () => {
            // 滑鼠離開 → 全部恢復成一般寬度
            chart.updateOptions({
              stroke: {
                width: chart.w.config.series.map((s) =>
                  s.type === "line" ? 2 : 1
                ),
              },
            });
          };
        });
      }

      function highlightConditions(rules) {
        if (!window.stockData || window.stockData.length === 0) return;

        let annotations = [];
        window.stockData.forEach((row, i) => {
          const prev = window.stockData[i - 1];
          if (!prev) return;

          // Note: Supabase must provide columns like 'Sma 5', 'Sma 20', 'MACD', 'MACD_signal', 'K', 'D', 'Bias'
          const sma5 = parseFloat(row["Sma 5"]);
          const sma20 = parseFloat(row["Sma 20"]);
          const prevSma5 = parseFloat(prev["Sma 5"]);
          const prevSma20 = parseFloat(prev["Sma 20"]);
          const macd = parseFloat(row["MACD"]);
          const macdSignal = parseFloat(row["Macd Dea"]); // Assumes 'MACD_signal' column exists
          const prevMacd = parseFloat(prev["MACD"]);
          const prevMacdSignal = parseFloat(prev["Macd Dea"]);
          const k = parseFloat(row["K"]);
          const d = parseFloat(row["D"]);
          const prevK = parseFloat(prev["K"]);
          const prevD = parseFloat(prev["D"]);
          const bias = parseFloat(row["Bias"]);

          if (rules.includes("sma-cross")) {
            if (prevSma5 < prevSma20 && sma5 >= sma20) {
              annotations.push(makeAnnotation(row.date, "SMA↑"));
            }
          }

          if (rules.includes("macd-cross")) {
            if (prevMacd < prevMacdSignal && macd >= macdSignal) {
              annotations.push(makeAnnotation(row.date, "MACD↑"));
            }
          }

          if (rules.includes("kd-cross")) {
            if (prevK < prevD && k >= d && k < 20) {
              annotations.push(makeAnnotation(row.date, "KD↑"));
            }
          }

          if (rules.includes("bias-high") && bias > 5) {
            annotations.push(makeAnnotation(row.date, "Bias>5", "#E74C3C"));
          }

          if (rules.includes("bias-low") && bias < -5) {
            annotations.push(makeAnnotation(row.date, "Bias<-5", "#2ECC71"));
          }
        });

        if (window.chart) {
          chart.updateOptions({
            annotations: { xaxis: annotations },
          });
        }
      }

      function toggleCustomDate() {
        const div = document.getElementById("customDateRange");
        if (div.style.display === "none" || div.style.display === "") {
          div.style.display = "block";
        } else {
          div.style.display = "none";
        }
      }

      // 時間功能列
      function setActive(el, range) {
        document
          .querySelectorAll(".time-range-item")
          .forEach((item) => item.classList.remove("active"));
        el.classList.add("active");
        // 按其他時間按鈕時隱藏自訂時間容器
        document.getElementById("customDateRange").style.display = "none";
        // 這裡是原本的載入函數
        loadStockWithRange(getSymbol(), range);
      }
      function toggleCustomDate() {
        const container = document.getElementById("customDateRange");
        const isHidden =
          container.style.display === "none" || container.style.display === "";
        // 顯示或隱藏
        container.style.display = isHidden ? "flex" : "none";
        // 取消其他時間按鈕的選中狀態
        document
          .querySelectorAll(".time-range-item")
          .forEach((item) => item.classList.remove("active"));
      }

      // 畫圖?
      function makeAnnotation(time, label, color = "#FF4560") {
        return {
          x: new Date(time).getTime(),
          borderColor: color,
          label: {
            borderColor: color,
            style: {
              color: "#fff",
              background: color,
              fontSize: "12px",
              padding: "2px 4px",
            },
            text: label,
            orientation: "horizontal",
            offsetY: 20,
          },
        };
      }
      document
        .getElementById("symbolInput")
        .addEventListener("input", async (e) => {
          const keyword = e.target.value.trim();
          const suggestions = document.getElementById("suggestions");
          if (!keyword) return (suggestions.style.display = "none");

          const { data, error } = await client
            .from("stocks_meta")
            .select("symbol, name_en, name_zh, short_name_en, short_name_zh")
            .or(
              `symbol.ilike.%${keyword}%,` +
                `name_en.ilike.%${keyword}%,` +
                `name_zh.ilike.%${keyword}%,` +
                `short_name_en.ilike.%${keyword}%,` +
                `short_name_zh.ilike.%${keyword}%`
            )

            .limit(10);

          if (error || !data || data.length === 0) {
            suggestions.innerHTML = `<div style='padding:8px;'>無符合股票</div>`;
            suggestions.style.display = "block";
            return;
          }

          suggestions.innerHTML = data
            .map((item) => {
              const nameDisplay =
                item.name_zh ||
                item.name_en ||
                item.short_name_zh ||
                item.short_name_en ||
                "";
              return `<div style='padding:8px; cursor:pointer' onclick='selectSymbol("${item.symbol}")'>${item.symbol} - ${nameDisplay}</div>`;
            })

            .join("");
          suggestions.style.display = "block";
        });

      // Hide suggestions when clicking outside
      document.addEventListener("click", function (event) {
        const suggestionsDiv = document.getElementById("suggestions");
        const input = document.getElementById("symbolInput");
        if (!suggestionsDiv.contains(event.target) && event.target !== input) {
          suggestionsDiv.style.display = "none";
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        loadStockWithRange("AAPL", "1y"); // Load Apple stock for 1 year by default
      });
    </script>
  </body>
</html>
