<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>è‚¡ç¥¨è³‡æ–™å±•ç¤º</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }
      th {
        background-color: #f2f2f2;
      }
      select,
      input[type="date"],
      button {
        font-size: 16px;
        margin: 5px;
        padding: 5px;
      }
      #chart {
        max-width: 1000px;
        margin: 20px auto;
      }
    </style>
  </head>
  <body>
    <h1>è‚¡ç¥¨è³‡æ–™</h1>

    <!-- è Ÿç‡­åœ–å€åŸŸ -->
    <div
      id="chart"
      style="max-width: 1200px; height: auto; margin: 20px auto"
    ></div>

    <!-- é¸æ“‡æ¢ä»¶ -->
    <label for="symbolSelect">è‚¡ç¥¨ä»£è™Ÿï¼š</label>
    <select id="symbolSelect">
      <option value="">è«‹é¸æ“‡</option>
      <option value="AAPL">AAPL</option>
      <option value="AMGN">AMGN</option>
      <option value="AXP">AXP</option>
      <option value="BA">BA</option>
      <option value="CAT">CAT</option>
      <option value="CRM">CRM</option>
      <option value="CSCO">CSCO</option>
      <option value="CVX">CVX</option>
      <option value="DIS">DIS</option>
      <option value="GS">GS</option>
      <option value="HD">HD</option>
      <option value="HON">HON</option>
      <option value="IBM">IBM</option>
      <option value="INTC">INTC</option>
      <option value="JNJ">JNJ</option>
      <option value="JPM">JPM</option>
      <option value="KO">KO</option>
      <option value="MCD">MCD</option>
      <option value="MMM">MMM</option>
      <option value="MRK">MRK</option>
      <option value="MSFT">MSFT</option>
      <option value="NKE">NKE</option>
      <option value="PG">PG</option>
      <option value="TRV">TRV</option>
      <option value="UNH">UNH</option>
      <option value="V">V</option>
      <option value="VZ">VZ</option>
      <option value="WBA">WBA</option>
      <option value="WMT">WMT</option>
    </select>

    <label>èµ·å§‹æ—¥ï¼š</label>
    <input type="date" id="startDate" />

    <label>çµæŸæ—¥ï¼š</label>
    <input type="date" id="endDate" />

    <button onclick="loadStocks()">æŸ¥è©¢</button>

    <!-- æŠ€è¡“æŒ‡æ¨™è¤‡é¸æ¡† -->
    <div id="indicatorOptions">
      <label><input type="checkbox" value="Volume Percentage" />Volume</label>
      <label><input type="checkbox" value="Sma 5" />SMA 5</label>
      <label><input type="checkbox" value="Sma 10" />SMA 10</label>
      <label><input type="checkbox" value="Sma 20" />SMA 20</label>
      <label><input type="checkbox" value="Sma 60" />SMA 60</label>
      <label><input type="checkbox" value="Sma 120" />SMA 120</label>
      <label><input type="checkbox" value="Sma 240" />SMA 240</label>
      <label><input type="checkbox" value="Macd" />MACD</label>
      <label><input type="checkbox" value="K" />K</label>
      <label><input type="checkbox" value="D" />D</label>
      <label><input type="checkbox" value="J" />J</label>
      <label><input type="checkbox" value="Atr" />ATR</label>
      <label><input type="checkbox" value="Cci" />CCI</label>
      <label><input type="checkbox" value="Mom 6" />MOM 6</label>
      <label><input type="checkbox" value="Mom 12" />MOM 12</label>
      <label><input type="checkbox" value="Mom 10" />MOM 10</label>
      <label><input type="checkbox" value="Mom 18" />MOM 18</label>
      <label><input type="checkbox" value="Roc 5" />ROC 5</label>
      <label><input type="checkbox" value="Roc 10" />ROC 10</label>
      <label><input type="checkbox" value="Roc 12" />ROC 12</label>
      <label><input type="checkbox" value="Willr" />Willr</label>
      <label><input type="checkbox" value="Bias" />Bias</label>
      <label><input type="checkbox" value="Volume Oscillator" />Volume Oscillator</label>
    </div>

    <!-- è Ÿç‡­åœ– -->
    <div id="chart"></div>

    <!-- è³‡æ–™è¡¨æ ¼ -->
    <table id="stockTable">
      <thead>
        <tr>
          <th>æ—¥æœŸ</th>
          <th>è‚¡ç¥¨ä»£è™Ÿ</th>
          <th>é–‹ç›¤åƒ¹</th>
          <th>æœ€é«˜åƒ¹</th>
          <th>æœ€ä½åƒ¹</th>
          <th>æ”¶ç›¤åƒ¹</th>
          <th>æˆäº¤é‡</th>
        </tr>
      </thead>
      <tbody id="stockBody"></tbody>
    </table>

    <script>
      const SUPABASE_URL = "https://cqtfffupninvnbxkbgjv.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxdGZmZnVwbmludm5ieGtiZ2p2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NDY4NjEsImV4cCI6MjA2NjMyMjg2MX0.joUVlX5EZdoL1XGzR2TIOnV6VfWhntKQzy7KXxcCbH0";

      const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      let chart;

      async function loadStocks() {
        const symbol = document.getElementById("symbolSelect").value;
        const start = document.getElementById("startDate").value;
        const end = document.getElementById("endDate").value;

        const selectedIndicators = Array.from(
          document.querySelectorAll('#indicatorOptions input[type="checkbox"]:checked')
        ).map(cb => cb.value);

        if (!symbol || !start || !end) {
          alert("è«‹é¸æ“‡è‚¡ç¥¨ä»£è™Ÿèˆ‡æ—¥æœŸå€é–“");
          return;
        }

        const { data, error } = await client
          .from("stocks")
          .select("*")
          .eq("symbol", symbol)
          .gte("date", start)
          .lte("date", end)
          .order("date", { ascending: true });

        const tbody = document.getElementById("stockBody");
        tbody.innerHTML = "";

        if (error || !data || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7">æ²’æœ‰è³‡æ–™</td></tr>`;
          return;
        }

        // æ›´æ–°è¡¨æ ¼
        data.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.date}</td>
            <td>${row.symbol}</td>
            <td>${parseFloat(row.open).toFixed(3)}</td>
            <td>${parseFloat(row.high).toFixed(3)}</td>
            <td>${parseFloat(row.low).toFixed(3)}</td>
            <td>${parseFloat(row.close).toFixed(3)}</td>
            <td>${parseFloat(row.volume).toFixed(3)}</td>
          `;
          tbody.appendChild(tr);
        });

        // ä¸»Kç·šåœ–è³‡æ–™
        const chartData = data.map((row) => ({
          x: new Date(row.date),
          y: [
            parseFloat(row.open),
            parseFloat(row.high),
            parseFloat(row.low),
            parseFloat(row.close),
          ],
        }));

        // é¡å¤–æŒ‡æ¨™ç·š
        const extraSeries = [];
        selectedIndicators.forEach((indicator) => {
          const seriesData = data.map((row) => {
            const val = parseFloat(row[indicator]);  // æ­£å¸¸å¯«æ³•
            return {
              x: new Date(row.date),
              y: !isNaN(val) ? val : null,
            };
          });

          extraSeries.push({
            name: indicator,
            type: "line",
            data: seriesData,
          });
        });
        console.log("ğŸ’¡ Sma 5 ç¬¬ä¸€ç­†ï¼š", data[0]["Sma 5"]);
        console.log("ğŸ’¡ è½‰æˆæ•¸å­—ï¼š", parseFloat(data[0]["Sma 5"]));

        // è‹¥å·²å­˜åœ¨åœ–è¡¨ï¼ŒéŠ·æ¯€
        if (chart) chart.destroy();

        // è‡ªå‹•è¨­å®š y è»¸ä¸Šä¸‹é™
        const prices = data.flatMap((row) => [parseFloat(row.high), parseFloat(row.low)]);
        const minY = Math.min(...prices) * 0.98;
        const maxY = Math.max(...prices) * 1.02;

        const options = {
          chart: {
            type: "line",
            height: 600,
            zoom: { enabled: true },
          },
          title: {
            text: `${symbol} K ç·šåœ– + æŠ€è¡“æŒ‡æ¨™`,
            align: "left",
          },
          xaxis: {
            type: "datetime",
          },
          yaxis: {
            min: minY,
            max: maxY,
            tooltip: { enabled: true },
          },
          series: [
            {
              name: "Kç·šåœ–",
              type: "candlestick",
              data: chartData,
            },
            ...extraSeries,
          ],
        };

        chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

        console.log("âœ… æŸ¥è©¢çµæœ sampleï¼š", data[0]);
        console.log("âœ… é¸æ“‡æŒ‡æ¨™ï¼š", selectedIndicators);
      }
    </script>
  </body>
</html>
