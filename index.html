<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>è‚¡ç¥¨è³‡æ–™å±•ç¤º</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
      if (
        location.hash.includes("access_token") &&
        !location.pathname.endsWith("ResetPassword.html")
      ) {
        // é‡å°å‘åˆ°æ­£ç¢ºé é¢
        const target = "/StockWebPage/ResetPassword.html" + location.hash;
        location.replace(target);
      }
    </script>
    <script>
      window.addEventListener("load", () => {
        const hash = window.location.hash;
        if (hash.includes("access_token") && hash.includes("type=signup")) {
          alert(" é©—è­‰æˆåŠŸï¼æ‚¨å·²å®Œæˆè¨»å†Šï¼Œå¯ä»¥ç™»å…¥ç³»çµ±äº†ï¼");
        }
      });
    </script>
    <script>
      window.addEventListener("load", () => {
        const hash = location.hash;
        console.log("ğŸ’¬ location.hash =", hash);

        if (hash.includes("access_token")) {
          document.body.innerHTML += "<p> access_token æ¥æ”¶åˆ°ï¼Œè·³è½‰æˆåŠŸ</p>";
        } else {
          document.body.innerHTML +=
            "<p> æ²’æœ‰ access_tokenï¼ŒSupabase æ²’æœ‰æˆåŠŸå°å›</p>";
        }
      });
    </script>

    <style>
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }
      th {
        background-color: #f2f2f2;
      }
      select,
      input[type="date"],
      button {
        font-size: 16px;
        margin: 5px;
        padding: 5px;
      }

      #chart {
        max-width: 1000px;
        margin: 20px auto;
      }
      .menu-container {
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 24px;
        z-index: 999;
      }

      .menu-icon {
        position: relative;
        cursor: pointer;
        user-select: none;
      }

      .dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 30px;
        background-color: #fff;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 120px;
      }

      .dropdown a {
        display: block;
        padding: 10px 15px;
        color: #333;
        text-decoration: none;
        font-size: 14px;
      }

      .dropdown a:hover {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <h1>è‚¡ç¥¨è³‡æ–™</h1>

    <!-- åŠ ä¸€å€‹ã€Œä¸‰æ§“é¸å–®ã€ -->
    <div class="menu-container" id="menuContainer">
      <div class="menu-icon">
        â˜°
        <div class="dropdown" id="dropdownMenu">
          <div
            id="user-email"
            style="padding: 8px 15px; font-weight: bold"
          ></div>
          <a id="login-btn" href="login.html">ç™»å…¥</a>
          <a id="register-btn" href="register.html">è¨»å†Š</a>
          <a id="logout-btn" href="#" onclick="logout()" style="display: none"
            >ç™»å‡º</a
          >
        </div>
      </div>
    </div>

    <!-- é¸æ“‡æ¢ä»¶ -->
    <label for="symbolSelect">è‚¡ç¥¨ä»£è™Ÿï¼š</label>
    <select id="symbolSelect">
      <option value="">è«‹é¸æ“‡</option>
      <option value="AAPL">AAPL</option>
      <option value="AMGN">AMGN</option>
      <option value="AXP">AXP</option>
      <option value="BA">BA</option>
      <option value="CAT">CAT</option>
      <option value="CRM">CRM</option>
      <option value="CSCO">CSCO</option>
      <option value="CVX">CVX</option>
      <option value="DIS">DIS</option>
      <option value="GS">GS</option>
      <option value="HD">HD</option>
      <option value="HON">HON</option>
      <option value="IBM">IBM</option>
      <option value="INTC">INTC</option>
      <option value="JNJ">JNJ</option>
      <option value="JPM">JPM</option>
      <option value="KO">KO</option>
      <option value="MCD">MCD</option>
      <option value="MMM">MMM</option>
      <option value="MRK">MRK</option>
      <option value="MSFT">MSFT</option>
      <option value="NKE">NKE</option>
      <option value="PG">PG</option>
      <option value="TRV">TRV</option>
      <option value="UNH">UNH</option>
      <option value="V">V</option>
      <option value="VZ">VZ</option>
      <option value="WBA">WBA</option>
      <option value="WMT">WMT</option>
    </select>

    <label>èµ·å§‹æ—¥ï¼š</label>
    <input type="date" id="startDate" />

    <label>çµæŸæ—¥ï¼š</label>
    <input type="date" id="endDate" />

    <button onclick="loadStocks()">æŸ¥è©¢</button>

    <!-- è Ÿç‡­åœ–æ¨™é¡Œ + OHLCé¡¯ç¤º -->
    <div style="max-width: 1200px; margin: 0 auto">
      <h2
        id="chartTitle"
        style="text-align: left; font-weight: bold; padding: 0 20px"
      ></h2>
      <div
        id="ohlcInfo"
        style="text-align: left; font-size: 16px; padding: 0 20px"
      ></div>
      <div id="chart"></div>
    </div>

    <!-- è³‡æ–™è¡¨æ ¼ -->
    <table id="stockTable">
      <thead>
        <tr>
          <th>æ—¥æœŸ</th>
          <th>è‚¡ç¥¨ä»£è™Ÿ</th>
          <th>é–‹ç›¤åƒ¹</th>
          <th>æœ€é«˜åƒ¹</th>
          <th>æœ€ä½åƒ¹</th>
          <th>æ”¶ç›¤åƒ¹</th>
          <th>æˆäº¤é‡</th>
        </tr>
      </thead>
      <tbody id="stockBody"></tbody>
    </table>

    <script>
      const SUPABASE_URL = "https://sbzzfjlmhvuchzwqllgf.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNienpmamxtaHZ1Y2h6d3FsbGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3NDE2OTQsImV4cCI6MjA2ODMxNzY5NH0.fvDVLvGLQdMRuCMXmja8ltpXC3TcjZxq78xbnt9Bh-U";

      const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      const menuContainer = document.getElementById("menuContainer");
      const dropdownMenu = document.getElementById("dropdownMenu");

      // è¨»å†Šé»æ“Šé€£çµ
      async function handleRedirect() {
        const hash = window.location.hash;
        if (hash && hash.includes("access_token")) {
          const { data, error } = await client.auth.getSessionFromUrl({
            storeSession: true,
          });
          if (error) {
            console.error("è™•ç† redirect ç™»å…¥å¤±æ•—:", error.message);
            return;
          }
          console.log("ç™»å…¥æˆåŠŸï¼Œä½¿ç”¨è€…è³‡è¨Šï¼š", data.session?.user);

          // å¯å°å‘åˆ°ä¸»ç•«é¢æˆ–æ¸…é™¤ URL ä¸­çš„ token
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );
        }
      }
      handleRedirect();

      // æ»‘é¼ ç§»å…¥é¡¯ç¤ºé¸å–®
      menuContainer.addEventListener("mouseenter", () => {
        dropdownMenu.style.display = "block";
      });

      // æ»‘é¼ ç§»å‡ºæ•´å€‹å®¹å™¨éš±è—é¸å–®
      menuContainer.addEventListener("mouseleave", () => {
        dropdownMenu.style.display = "none";
      });

      // ç™»å‡º
      async function logout() {
        const { error } = await client.auth.signOut();
        if (!error) {
          alert("å·²ç™»å‡º");
          checkLoginStatus();
          hideMenu();
        }
      }

      // åˆ¤æ–·ç™»å…¥ç‹€æ…‹
      async function checkLoginStatus() {
        const {
          data: { user },
        } = await client.auth.getUser();

        const emailSpan = document.getElementById("user-email");
        const loginBtn = document.getElementById("login-btn");
        const registerBtn = document.getElementById("register-btn");
        const logoutBtn = document.getElementById("logout-btn");

        if (user) {
          emailSpan.textContent = user.email;
          emailSpan.style.display = "block";
          loginBtn.style.display = "none";
          registerBtn.style.display = "none";
          logoutBtn.style.display = "block";
        } else {
          emailSpan.textContent = "";
          emailSpan.style.display = "none";
          loginBtn.style.display = "block";
          registerBtn.style.display = "block";
          logoutBtn.style.display = "none";
        }
      }

      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get("access_token");
      const refreshToken = hashParams.get("refresh_token");

      if (accessToken && refreshToken) {
        supabase.auth
          .setSession({
            access_token: accessToken,
            refresh_token: refreshToken,
          })
          .then(() => {
            // æˆåŠŸç™»å…¥ï¼Œè·³è½‰æˆ–é¡¯ç¤ºç™»å…¥ç‹€æ…‹
            window.location.hash = ""; // æ¸…æ‰ URL hash
            alert("ç™»å…¥æˆåŠŸ");
          });
      }
      window.onload = checkLoginStatus;

      let chart;

      async function loadStocks() {
        const symbol = document.getElementById("symbolSelect").value;
        const start = document.getElementById("startDate").value;
        const end = document.getElementById("endDate").value;

        const selectedIndicators = Array.from(
          document.querySelectorAll(
            '#indicatorOptions input[type="checkbox"]:checked'
          )
        ).map((cb) => cb.value);

        if (!symbol || !start || !end) {
          alert("è«‹é¸æ“‡è‚¡ç¥¨ä»£è™Ÿèˆ‡æ—¥æœŸå€é–“");
          return;
        }

        const { data, error } = await client
          .from("stocks")
          .select("*")
          .eq("symbol", symbol)
          .gte("date", start)
          .lte("date", end)
          .order("date", { ascending: true });

        const tbody = document.getElementById("stockBody");
        tbody.innerHTML = "";

        if (error || !data || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7">æ²’æœ‰è³‡æ–™</td></tr>`;
          return;
        }

        // æ›´æ–°è¡¨æ ¼
        data.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.date}</td>
            <td>${row.symbol}</td>
            <td>${parseFloat(row.open).toFixed(3)}</td>
            <td>${parseFloat(row.high).toFixed(3)}</td>
            <td>${parseFloat(row.low).toFixed(3)}</td>
            <td>${parseFloat(row.close).toFixed(3)}</td>
            <td>${parseFloat(row.volume).toFixed(3)}</td>
          `;
          tbody.appendChild(tr);
        });

        // ä¸»Kç·šåœ–è³‡æ–™
        const chartData = data.map((row) => ({
          x: new Date(row.date),
          y: [
            parseFloat(row.open),
            parseFloat(row.high),
            parseFloat(row.low),
            parseFloat(row.close),
          ],
        }));

        const allIndicators = [
          "Sma 5",
          "Sma 10",
          "Sma 20",
          "Sma 60",
          "Sma 120",
          "Sma 240",
          "MACD",
          "K",
          "D",
          "J",
          "Atr",
          "Cci",
          "Mom 6",
          "Mom 10",
          "Mom 12",
          "Mom 18",
          "Roc 5",
          "Roc 10",
          "Roc 12",
          "Willr",
          "Bias",
          "Volume Percentage",
          "Volume Oscillator",
        ];

        const extraSeries = allIndicators.map((indicator) => {
          const seriesData = data.map((row) => {
            const val = parseFloat(row[indicator]);
            return {
              x: new Date(row.date),
              y: !isNaN(val) ? val : null,
            };
          });

          return {
            name: indicator,
            type: "line",
            data: seriesData,
            visible: false, // ApexCharts æœƒè‡ªå‹•é¡¯ç¤º legend ä½†ä¸ç•«åœ–
          };
        });

        console.log(" Sma 5 ç¬¬ä¸€ç­†ï¼š", data[0]["Sma 5"]);
        console.log(" è½‰æˆæ•¸å­—ï¼š", parseFloat(data[0]["Sma 5"]));

        // è‹¥å·²å­˜åœ¨åœ–è¡¨ï¼ŒéŠ·æ¯€
        if (chart) chart.destroy();

        // è‡ªå‹•è¨­å®š y è»¸ä¸Šä¸‹é™
        const prices = data.flatMap((row) => [
          parseFloat(row.high),
          parseFloat(row.low),
        ]);
        const minY = Math.min(...prices) * 0.98;
        const maxY = Math.max(...prices) * 1.02;

        document.getElementById("chartTitle").innerText = `${symbol}`;

        const options = {
          chart: {
            type: "line",
            height: 600,
            zoom: { enabled: true },
            events: {
              mounted: function (chartContext, config) {
                // å„²å­˜åˆå§‹ zoom ç¯„åœ
                const xRange = chartContext.w.globals.minX;
                const yRange = chartContext.w.globals.maxX;
                originalMinX = xRange;
                originalMaxX = yRange;
              },
              zoomed: function (chartContext, { xaxis }) {
                const zoomSpan = xaxis.max - xaxis.min;
                const totalSpan = originalMaxX - originalMinX;
                const zoomRatio = totalSpan / zoomSpan;

                // æ§åˆ¶ marker å¤§å°ï¼šéš¨ zoom å¢åŠ ä½†å¹³æ»‘ï¼Œé™åˆ¶æœ€å¤§ä¸è¶…é 4
                const newSize = Math.max(
                  2,
                  Math.min(4, 2 + Math.log10(zoomRatio))
                );

                chart.updateOptions(
                  {
                    markers: {
                      size: newSize,
                    },
                  },
                  false,
                  true
                );
              },
              legendClick: function (chartContext, seriesIndex, config) {
                const series = chartContext.w.config.series[seriesIndex];
                const currentOpacity = series.opacity || 1;

                // åˆ‡æ› opacityï¼š0 <-> 1
                const newOpacity = currentOpacity === 0 ? 1 : 0;

                chartContext.updateOptions(
                  {
                    series: chartContext.w.config.series.map((s, i) =>
                      i === seriesIndex ? { ...s, opacity: newOpacity } : s
                    ),
                  },
                  false,
                  true
                );
              },
            },
          },

          legend: {
            position: "right",
            horizontalAlign: "left",
            show: true,
          },

          tooltip: {
            shared: true,
            intersect: false,
            y: {
              formatter: function (val, opts) {
                const seriesIndex = opts.seriesIndex;
                const dataPointIndex = opts.dataPointIndex;

                // åªåœ¨ä¸» K ç·šåœ–æ™‚æ›´æ–° OHLC è³‡è¨Šï¼ˆindex = 0ï¼‰
                if (seriesIndex === 0) {
                  const [open, high, low, close] = chartData[dataPointIndex].y;
                  const date = chartData[dataPointIndex].x
                    .toISOString()
                    .split("T")[0];
                  const color =
                    close > open
                      ? "#2ecc71"
                      : close < open
                      ? "#e74c3c"
                      : "#aaa";

                  document.getElementById(
                    "ohlcInfo"
                  ).innerHTML = `æ—¥æœŸ: ${date}ã€€
                    é–‹: <span style="color:${color}">${open.toFixed(2)}</span>ã€€
                    é«˜: <span style="color:${color}">${high.toFixed(2)}</span>ã€€
                    ä½: <span style="color:${color}">${low.toFixed(2)}</span>ã€€
                    æ”¶: <span style="color:${color}">${close.toFixed(
                    2
                  )}</span>`;
                }

                return val?.toFixed ? val.toFixed(2) : val;
              },
            },
          },

          xaxis: {
            type: "datetime",
          },

          yaxis: {
            min: minY,
            max: maxY,
            tooltip: { enabled: true },
            labels: {
              formatter: function (val) {
                return Number(val.toFixed(2)); // æˆ–æ”¹æˆ parseFloat(val).toFixed(4)
              },
            },
          },

          stroke: { width: 1 },

          markers: { size: 2 },

          series: [
            {
              name: "Kç·šåœ–",
              type: "candlestick",
              data: chartData,
            },
            ...extraSeries,
          ],
        };

        chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

        console.log(" æŸ¥è©¢çµæœ sampleï¼š", data[0]);
        console.log(" é¸æ“‡æŒ‡æ¨™ï¼š", selectedIndicators);
      }

      function showMenu() {
        document.getElementById("dropdownMenu").style.display = "block";
      }

      function hideMenu() {
        document.getElementById("dropdownMenu").style.display = "none";
      }
    </script>
  </body>
</html>
